<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Integrada de Acolhimento (AMIRA/GO)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Markdown Parser (Para Respostas da IA) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Toast Notifications -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root { --brand-blue: #0056b3; --brand-yellow: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; }
        
        /* Animações */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos Customizados */
        .sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-link:hover { background-color: rgba(255,255,255,0.1); border-left-color: var(--brand-yellow); }
        .active-link { background-color: rgba(255,255,255,0.15); border-left-color: var(--brand-yellow); font-weight: bold; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <!-- 1. TELA DE LOGIN (MOCKUP) -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl flex overflow-hidden h-[600px]">
            <!-- Lado Esquerdo (Branding) -->
            <div class="w-1/2 bg-gradient-to-br from-blue-900 to-blue-800 p-12 text-white hidden md:flex flex-col justify-between relative">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                
                <div class="z-10">
                    <i class="fa-solid fa-hands-holding-circle text-5xl mb-6 text-yellow-400"></i>
                    <h1 class="text-4xl font-bold mb-2 leading-tight">Protocolo<br>Goianiense</h1>
                    <p class="text-blue-200 text-lg">Acolhimento, Escuta e Justiça Social</p>
                </div>

                <div class="space-y-4 z-10">
                    <div class="flex items-center gap-3 bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                        <i class="fa-solid fa-robot text-yellow-400 text-xl"></i>
                        <div>
                            <p class="font-bold text-sm">IA Agêntica Integrada</p>
                            <p class="text-xs opacity-75">Triagem preditiva e análise de risco</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                        <i class="fa-solid fa-network-wired text-green-400 text-xl"></i>
                        <div>
                            <p class="font-bold text-sm">Rede Intersetorial</p>
                            <p class="text-xs opacity-75">Conexão CRAS, PF, Saúde e Educação</p>
                        </div>
                    </div>
                </div>
                
                <p class="text-xs text-blue-300 z-10">© 2025 Cátedra Sérgio Vieira de Mello (UFG)</p>
            </div>

            <!-- Lado Direito (Formulário) -->
            <div class="w-full md:w-1/2 p-12 flex flex-col justify-center bg-gray-50">
                <div class="text-center mb-8 md:hidden">
                    <i class="fa-solid fa-hands-holding-circle text-4xl text-blue-900"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mt-2">Protocolo Goianiense</h2>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-2">Acesse o Sistema</h2>
                <p class="text-gray-500 mb-8 text-sm">Selecione seu perfil de atuação para entrar na plataforma.</p>
                
                <div class="space-y-3">
                    <button onclick="login('triagem')" class="w-full group flex items-center p-4 bg-white border border-gray-200 rounded-xl hover:border-blue-500 hover:shadow-md transition-all text-left">
                        <div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center mr-4 group-hover:bg-blue-600 group-hover:text-white transition">
                            <i class="fa-solid fa-headset"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">Triagem / Escuta</div>
                            <div class="text-xs text-gray-500">CRAS, CSVM, Pastoral (Porta de Entrada)</div>
                        </div>
                        <i class="fa-solid fa-chevron-right ml-auto text-gray-300 group-hover:text-blue-500"></i>
                    </button>

                    <button onclick="login('gestao')" class="w-full group flex items-center p-4 bg-white border border-gray-200 rounded-xl hover:border-purple-500 hover:shadow-md transition-all text-left">
                        <div class="bg-purple-100 text-purple-600 w-10 h-10 rounded-full flex items-center justify-center mr-4 group-hover:bg-purple-600 group-hover:text-white transition">
                            <i class="fa-solid fa-chart-pie"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">Gestão de Fluxos</div>
                            <div class="text-xs text-gray-500">Coordenação, Observatório, SEDS</div>
                        </div>
                        <i class="fa-solid fa-chevron-right ml-auto text-gray-300 group-hover:text-purple-500"></i>
                    </button>
                </div>
                
                <div class="mt-8 border-t border-gray-200 pt-6">
                     <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">Configuração Opcional</label>
                     <div class="relative">
                        <i class="fa-brands fa-google absolute left-3 top-2.5 text-gray-400"></i>
                        <input type="password" id="apiKeyInput" class="w-full border border-gray-300 bg-white rounded-lg pl-10 p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cole sua API Key do Google Gemini aqui...">
                     </div>
                     <p class="text-[10px] text-gray-400 mt-1">Necessário apenas para as funções de IA generativa.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. APLICAÇÃO PRINCIPAL -->
    <div id="app-layout" class="hidden flex h-full">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20">
            <div class="h-16 flex items-center px-6 bg-slate-950 border-b border-slate-800">
                <i class="fa-solid fa-hands-holding-circle text-yellow-400 mr-3"></i>
                <span class="font-bold text-lg tracking-tight">AMIRA/GO</span>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto">
                <!-- Perfil -->
                <div class="bg-slate-800/50 rounded-lg p-3 flex items-center gap-3 mb-8 border border-slate-700">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center font-bold shadow-lg" id="user-avatar">U</div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold truncate" id="user-name">Usuário</p>
                        <p class="text-xs text-slate-400 truncate" id="user-role">Função</p>
                    </div>
                </div>

                <!-- Menu -->
                <nav class="space-y-1">
                    <p class="px-4 text-xs font-bold text-slate-500 uppercase mb-2 mt-4">Principal</p>
                    <button onclick="nav('dashboard')" id="btn-dashboard" class="sidebar-link w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 text-sm text-slate-300 hover:text-white">
                        <i class="fa-solid fa-chart-simple w-5 text-center"></i> Dashboard
                    </button>
                    <button onclick="nav('triagem')" id="btn-triagem" class="sidebar-link w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 text-sm text-slate-300 hover:text-white">
                        <i class="fa-solid fa-file-medical w-5 text-center"></i> Nova Triagem
                    </button>
                    <button onclick="nav('casos')" id="btn-casos" class="sidebar-link w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 text-sm text-slate-300 hover:text-white">
                        <i class="fa-solid fa-users-viewfinder w-5 text-center"></i> Base de Casos
                    </button>

                    <p class="px-4 text-xs font-bold text-slate-500 uppercase mb-2 mt-6">Ferramentas</p>
                    <button onclick="openAIHelp()" class="sidebar-link w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 text-sm text-indigo-300 hover:text-white hover:bg-indigo-900/30">
                        <i class="fa-solid fa-wand-magic-sparkles w-5 text-center"></i> Assistente IA
                    </button>
                    <button onclick="alert('Funcionalidade de relatórios em desenvolvimento.')" class="sidebar-link w-full text-left px-4 py-2.5 rounded-lg flex items-center gap-3 text-sm text-slate-300 hover:text-white">
                        <i class="fa-solid fa-print w-5 text-center"></i> Relatórios
                    </button>
                </nav>
            </div>

            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-sm text-red-400 hover:text-red-300 hover:bg-red-900/20 py-2 rounded transition">
                    <i class="fa-solid fa-power-off"></i> Sair do Sistema
                </button>
            </div>
        </aside>

        <!-- CONTEÚDO PRINCIPAL -->
        <main class="flex-1 flex flex-col relative bg-gray-50 overflow-hidden">
            <!-- Header Mobile/Desktop -->
            <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-10">
                <div class="flex items-center gap-4">
                    <button class="md:hidden text-gray-500 hover:text-gray-800"><i class="fa-solid fa-bars"></i></button>
                    <h2 class="text-xl font-bold text-gray-800" id="page-title">Visão Geral</h2>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Notificações -->
                    <div class="relative group">
                        <button class="text-gray-400 hover:text-blue-600 transition relative">
                            <i class="fa-solid fa-bell text-xl"></i>
                            <span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
                        </button>
                        <!-- Dropdown Simulado -->
                        <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-100 hidden group-hover:block p-2 text-sm z-50">
                            <p class="font-bold px-2 py-1 text-gray-700 border-b mb-1">Notificações</p>
                            <div class="px-2 py-1 hover:bg-gray-50 rounded cursor-pointer text-xs text-gray-600">
                                <strong class="text-blue-600">Novo Encaminhamento</strong><br>Caso #102 enviado para Saúde.
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- ÁREA DE VIEWS (SPA) -->
            <div id="content-area" class="flex-1 overflow-y-auto p-6">
                
                <!-- 1. VIEW: DASHBOARD -->
                <div id="view-dashboard" class="hidden fade-in max-w-7xl mx-auto">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Casos</p>
                                    <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-total">0</h3>
                                </div>
                                <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i class="fa-solid fa-folder-open"></i></div>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full" style="width: 70%"></div></div>
                        </div>

                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Urgentes</p>
                                    <h3 class="text-3xl font-bold text-red-600 mt-1" id="stat-urgent">0</h3>
                                </div>
                                <div class="p-2 bg-red-50 text-red-600 rounded-lg"><i class="fa-solid fa-triangle-exclamation"></i></div>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5"><div class="bg-red-500 h-1.5 rounded-full" style="width: 45%"></div></div>
                        </div>

                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Em Andamento</p>
                                    <h3 class="text-3xl font-bold text-yellow-600 mt-1" id="stat-active">0</h3>
                                </div>
                                <div class="p-2 bg-yellow-50 text-yellow-600 rounded-lg"><i class="fa-solid fa-clock"></i></div>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5"><div class="bg-yellow-500 h-1.5 rounded-full" style="width: 60%"></div></div>
                        </div>

                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Concluídos</p>
                                    <h3 class="text-3xl font-bold text-green-600 mt-1" id="stat-done">0</h3>
                                </div>
                                <div class="p-2 bg-green-50 text-green-600 rounded-lg"><i class="fa-solid fa-check-circle"></i></div>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5"><div class="bg-green-500 h-1.5 rounded-full" style="width: 30%"></div></div>
                        </div>
                    </div>

                    <!-- Tabela Recente -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-gray-700">Casos Recentes</h3>
                            <button onclick="nav('casos')" class="text-sm text-blue-600 hover:underline font-medium">Ver Todos</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                                    <tr>
                                        <th class="px-6 py-3 font-bold">Protocolo</th>
                                        <th class="px-6 py-3 font-bold">Nome</th>
                                        <th class="px-6 py-3 font-bold">Origem</th>
                                        <th class="px-6 py-3 font-bold">Status</th>
                                        <th class="px-6 py-3 font-bold">Ação</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="dashboard-table-body">
                                    <!-- JS Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. VIEW: NOVA TRIAGEM -->
                <div id="view-triagem" class="hidden fade-in max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-white">
                            <h2 class="text-2xl font-bold">Nova Triagem & Escuta</h2>
                            <p class="opacity-80 text-sm">Registro inicial para geração de protocolo unificado.</p>
                        </div>
                        
                        <div class="p-8">
                            <!-- AI AREA -->
                            <div class="mb-8 bg-indigo-50 rounded-xl border border-indigo-100 p-5 relative group">
                                <div class="absolute top-3 right-3">
                                    <span class="bg-white text-indigo-600 text-[10px] px-2 py-1 rounded-full font-bold shadow uppercase tracking-wide">Gemini AI</span>
                                </div>
                                <label class="block text-indigo-900 font-bold mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-microphone-lines"></i> Relato Livre do Atendimento
                                </label>
                                <p class="text-xs text-indigo-700 mb-3">Descreva a situação (ex: "Maria, venezuelana, 30 anos, sem documentos, precisa de médico urgente"). A IA preencherá os campos.</p>
                                <textarea id="narrative-input" class="w-full border border-indigo-200 rounded-lg p-3 text-sm h-32 focus:ring-2 focus:ring-indigo-400 outline-none transition" placeholder="Digite ou cole a transcrição aqui..."></textarea>
                                <div class="flex justify-end mt-3">
                                    <button onclick="processAI()" id="btn-ai" class="bg-indigo-600 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow-sm flex items-center gap-2">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Analisar Automaticamente
                                    </button>
                                </div>
                            </div>

                            <form id="form-triagem" onsubmit="saveCase(event)" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome Completo</label>
                                        <input type="text" name="name" required class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nacionalidade / Etnia</label>
                                        <input type="text" name="origin" required class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Telefone (WhatsApp)</label>
                                        <input type="text" name="phone" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="55629...">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nível de Prioridade</label>
                                        <select name="priority" id="priority-select" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="Normal">Normal</option>
                                            <option value="Alta">Alta</option>
                                            <option value="Urgente">Urgente (Risco à Vida/Direitos)</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Encaminhamentos Necessários</label>
                                    <div class="flex flex-wrap gap-3" id="tags-container">
                                        <!-- Checkboxes estilizados -->
                                        <label class="cursor-pointer select-none">
                                            <input type="checkbox" name="tags" value="Documentação" class="peer sr-only">
                                            <div class="px-4 py-2 rounded-full bg-gray-100 text-gray-600 peer-checked:bg-blue-600 peer-checked:text-white transition text-sm font-medium border border-gray-200">Documentação (PF)</div>
                                        </label>
                                        <label class="cursor-pointer select-none">
                                            <input type="checkbox" name="tags" value="Saúde" class="peer sr-only">
                                            <div class="px-4 py-2 rounded-full bg-gray-100 text-gray-600 peer-checked:bg-red-500 peer-checked:text-white transition text-sm font-medium border border-gray-200">Saúde (SUS)</div>
                                        </label>
                                        <label class="cursor-pointer select-none">
                                            <input type="checkbox" name="tags" value="Educação" class="peer sr-only">
                                            <div class="px-4 py-2 rounded-full bg-gray-100 text-gray-600 peer-checked:bg-yellow-500 peer-checked:text-white transition text-sm font-medium border border-gray-200">Educação</div>
                                        </label>
                                        <label class="cursor-pointer select-none">
                                            <input type="checkbox" name="tags" value="Assistência" class="peer sr-only">
                                            <div class="px-4 py-2 rounded-full bg-gray-100 text-gray-600 peer-checked:bg-purple-500 peer-checked:text-white transition text-sm font-medium border border-gray-200">Assistência (CRAS)</div>
                                        </label>
                                    </div>
                                </div>

                                <div class="pt-6 border-t border-gray-100 flex justify-end gap-4">
                                    <button type="button" onclick="nav('dashboard')" class="px-6 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition">Cancelar</button>
                                    <button type="submit" class="bg-blue-600 text-white px-8 py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">Gerar Protocolo</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 3. VIEW: DETALHES DO CASO -->
                <div id="view-case-detail" class="hidden fade-in max-w-6xl mx-auto">
                    <!-- Header do Caso -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <div class="flex items-center gap-3 mb-1">
                                <button onclick="nav('dashboard')" class="text-gray-400 hover:text-blue-600 transition"><i class="fa-solid fa-arrow-left"></i></button>
                                <span class="text-xs font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded" id="detail-protocol">GO-000</span>
                                <span id="detail-priority-badge" class="text-xs font-bold px-2 py-1 rounded uppercase">Normal</span>
                            </div>
                            <h1 class="text-3xl font-bold text-gray-800" id="detail-name">Nome do Migrante</h1>
                            <p class="text-gray-500 flex items-center gap-2 text-sm mt-1">
                                <i class="fa-solid fa-earth-americas"></i> <span id="detail-origin">Origem</span>
                                <span class="text-gray-300">|</span>
                                <i class="fa-brands fa-whatsapp"></i> <span id="detail-phone">Tel</span>
                            </p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="notifyWhatsapp()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow transition flex items-center gap-2">
                                <i class="fa-brands fa-whatsapp"></i> Notificar
                            </button>
                            <button onclick="printCase()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-50 transition flex items-center gap-2">
                                <i class="fa-solid fa-print"></i> Imprimir
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Coluna Esquerda (Fluxo) -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Card Fluxo -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h3 class="font-bold text-gray-800 mb-6 border-b pb-2">Fluxo de Atendimento</h3>
                                <div class="space-y-0" id="steps-timeline">
                                    <!-- Steps Injected JS -->
                                </div>
                                
                                <!-- Adicionar Passo (Apenas Gestores) -->
                                <div id="manager-actions" class="mt-8 bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-2">Adicionar Providência</label>
                                    <div class="flex gap-2">
                                        <select id="new-step-entity" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                            <option value="Polícia Federal">Polícia Federal</option>
                                            <option value="Saúde (SMS)">Saúde</option>
                                            <option value="Educação">Educação</option>
                                            <option value="Assistência Social">Assistência Social</option>
                                        </select>
                                        <input type="text" id="new-step-desc" class="flex-1 bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Descrição da ação...">
                                        <button onclick="addStep()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">Adicionar</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Coluna Direita (Infos) -->
                        <div class="space-y-6">
                            <!-- IA Analysis -->
                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-xl p-6 shadow-lg relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-robot fa-4x"></i></div>
                                <h4 class="font-bold text-yellow-400 mb-2 text-sm uppercase tracking-wider">Análise Inteligente</h4>
                                <p class="text-sm text-gray-300 italic leading-relaxed" id="detail-ai-text">Analisando dados...</p>
                            </div>

                            <!-- Arquivos -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                                <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase">Documentos</h4>
                                <ul id="detail-files" class="space-y-2 mb-4"></ul>
                                <label class="block w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer transition">
                                    <input type="file" class="hidden" onchange="uploadFile(this)">
                                    <i class="fa-solid fa-cloud-arrow-up text-gray-400 mb-1"></i>
                                    <span class="block text-xs text-gray-500 font-medium">Clique para anexar</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 4. VIEW: BASE DE CASOS (LISTA COMPLETA) -->
                <div id="view-casos" class="hidden fade-in max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Base de Casos Unificada</h2>
                        <!-- Filtros -->
                        <div class="flex gap-4 mb-6">
                            <input type="text" onkeyup="renderCasesList(this.value)" placeholder="Pesquisar..." class="flex-1 border p-2 rounded-lg">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="cases-grid">
                            <!-- Cards -->
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Scripts Lógica -->
    <script>
        // --- Estado ---
        let currentUser = null;
        let apiKey = localStorage.getItem('gemini_key_v2') || '';
        
        // --- Dados Simulados (Mock Database) ---
        const db = {
            cases: [
                {
                    id: 1,
                    protocol: 'GO-2025-001',
                    name: 'Marisol Silva',
                    origin: 'Venezuela (Warao)',
                    phone: '5562999999999',
                    priority: 'Urgente',
                    status: 'andamento',
                    narrative: 'Gestante de 7 meses, indígena Warao, sem documentação e necessitando de abrigo imediato. Não fala português fluente.',
                    tags: ['Saúde', 'Abrigo', 'Documentação'],
                    steps: [
                        { entity: 'Triagem', desc: 'Escuta inicial realizada no CRAS.', date: '24/04 09:00', status: 'done' },
                        { entity: 'Saúde (SMS)', desc: 'Encaminhamento para Pré-Natal de Alto Risco.', date: '24/04 10:30', status: 'pending' }
                    ],
                    files: ['Encaminhamento_Saude.pdf']
                },
                {
                    id: 2,
                    protocol: 'GO-2025-002',
                    name: 'Jean Baptiste',
                    origin: 'Haiti',
                    phone: '5562988888888',
                    priority: 'Normal',
                    status: 'concluido',
                    narrative: 'Solicita renovação de protocolo de refúgio e intermediação de mão de obra.',
                    tags: ['Documentação', 'Emprego'],
                    steps: [
                        { entity: 'Triagem', desc: 'Triagem realizada.', date: '20/04', status: 'done' },
                        { entity: 'Polícia Federal', desc: 'Documento renovado com sucesso.', date: '22/04', status: 'done' }
                    ],
                    files: ['Protocolo_PF.jpg']
                }
            ]
        };

        // --- Funções de Sistema ---

        function login(role) {
            const profiles = {
                'triagem': { name: 'Maria (Atendente)', role: 'Triagem / Ponta', avatar: 'M' },
                'gestao': { name: 'Dr. Carlos', role: 'Coordenação Geral', avatar: 'C' }
            };

            currentUser = { id: role, ...profiles[role] };
            
            // Save API Key if present
            const key = document.getElementById('apiKeyInput').value;
            if(key) { apiKey = key; localStorage.setItem('gemini_key_v2', key); }

            // Update UI
            document.getElementById('user-name').innerText = currentUser.name;
            document.getElementById('user-role').innerText = currentUser.role;
            document.getElementById('user-avatar').innerText = currentUser.avatar;

            // Permissions
            if(role === 'triagem') {
                document.getElementById('manager-actions').classList.add('hidden');
            } else {
                document.getElementById('manager-actions').classList.remove('hidden');
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-layout').classList.remove('hidden');
            
            updateStats();
            renderRecentTable();
            nav('dashboard');
        }

        function logout() {
            location.reload();
        }

        function nav(view) {
            ['dashboard', 'triagem', 'case-detail', 'casos'].forEach(v => {
                document.getElementById('view-'+v).classList.add('hidden');
            });
            document.getElementById('view-'+view).classList.remove('hidden');

            // Update Active Link Style
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active-link'));
            const activeBtn = document.getElementById('btn-'+view);
            if(activeBtn) activeBtn.classList.add('active-link');

            if(view === 'dashboard') {
                updateStats();
                renderRecentTable();
            }
            if(view === 'casos') renderCasesList();
        }

        // --- Dashboard Logic ---
        function updateStats() {
            document.getElementById('stat-total').innerText = db.cases.length;
            document.getElementById('stat-urgent').innerText = db.cases.filter(c => c.priority === 'Urgente').length;
            document.getElementById('stat-active').innerText = db.cases.filter(c => c.status === 'andamento').length;
            document.getElementById('stat-done').innerText = db.cases.filter(c => c.status === 'concluido').length;
        }

        function renderRecentTable() {
            const tbody = document.getElementById('dashboard-table-body');
            tbody.innerHTML = db.cases.slice(0, 5).map(c => `
                <tr class="hover:bg-gray-50 transition border-b border-gray-100 last:border-0">
                    <td class="px-6 py-4 font-mono text-xs text-gray-500">${c.protocol}</td>
                    <td class="px-6 py-4 font-bold text-gray-800">${c.name}</td>
                    <td class="px-6 py-4 text-gray-600">${c.origin}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${getStatusColor(c.priority)}">${c.priority}</span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="openCase(${c.id})" class="text-blue-600 hover:text-blue-800 font-medium text-xs uppercase tracking-wide">Ver Detalhes</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(p) {
            if(p === 'Urgente') return 'bg-red-100 text-red-700';
            if(p === 'Alta') return 'bg-yellow-100 text-yellow-700';
            return 'bg-blue-100 text-blue-700';
        }

        // --- Case Detail Logic ---
        let activeCaseId = null;

        function openCase(id) {
            activeCaseId = id;
            const c = db.cases.find(x => x.id === id);
            if(!c) return;

            // Basic Info
            document.getElementById('detail-protocol').innerText = c.protocol;
            document.getElementById('detail-name').innerText = c.name;
            document.getElementById('detail-origin').innerText = c.origin;
            document.getElementById('detail-phone').innerText = c.phone;
            
            const badge = document.getElementById('detail-priority-badge');
            badge.innerText = c.priority;
            badge.className = `text-xs font-bold px-2 py-1 rounded uppercase ${getStatusColor(c.priority)}`;

            document.getElementById('detail-ai-text').innerText = c.narrative || "Sem narrativa.";

            // Render Steps
            renderSteps(c);
            
            // Render Files
            renderFiles(c);

            nav('case-detail');
        }

        function renderSteps(c) {
            const container = document.getElementById('steps-timeline');
            container.innerHTML = c.steps.map((s, idx) => `
                <div class="flex gap-4">
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center z-10 ${s.status === 'done' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}">
                            <i class="fa-solid ${s.status === 'done' ? 'fa-check' : 'fa-hourglass'} text-xs"></i>
                        </div>
                        ${idx !== c.steps.length - 1 ? '<div class="w-0.5 h-full bg-gray-200 -mt-2 -mb-2"></div>' : ''}
                    </div>
                    <div class="pb-8 pt-1">
                        <h5 class="font-bold text-gray-800 text-sm">${s.entity}</h5>
                        <p class="text-sm text-gray-600">${s.desc}</p>
                        <span class="text-xs text-gray-400">${s.date}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderFiles(c) {
            const list = document.getElementById('detail-files');
            list.innerHTML = c.files.map(f => `
                <li class="flex items-center justify-between bg-gray-50 p-3 rounded border border-gray-100">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-file-pdf text-red-500 text-lg"></i>
                        <span class="text-sm text-gray-700 font-medium">${f}</span>
                    </div>
                    <button class="text-gray-400 hover:text-blue-600"><i class="fa-solid fa-download"></i></button>
                </li>
            `).join('');
        }

        function addStep() {
            const entity = document.getElementById('new-step-entity').value;
            const desc = document.getElementById('new-step-desc').value;
            if(!desc) return;

            const c = db.cases.find(x => x.id === activeCaseId);
            c.steps.push({
                entity: entity, desc: desc, date: new Date().toLocaleDateString(), status: 'pending'
            });
            c.status = 'andamento'; // Reopen case
            renderSteps(c);
            document.getElementById('new-step-desc').value = '';
            Toastify({ text: "Providência adicionada!", style: { background: "#10B981" } }).showToast();
        }

        function uploadFile(input) {
            if(input.files[0]) {
                const c = db.cases.find(x => x.id === activeCaseId);
                c.files.push(input.files[0].name);
                renderFiles(c);
                Toastify({ text: "Arquivo anexado!", style: { background: "#3B82F6" } }).showToast();
            }
        }

        // --- AI & Automation ---
        async function processAI() {
            const text = document.getElementById('narrative-input').value;
            if(!text) return alert("Digite um relato.");
            const btn = document.getElementById('btn-ai');
            
            // Mock extraction data
            let extracted = { name: 'Não identificado', origin: 'Não identificado', priority: 'Normal', tags: [] };

            if(apiKey) {
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processando...';
                try {
                    const prompt = `Extraia JSON (name, origin, priority[Normal/Alta/Urgente], tags[]) do texto: "${text}"`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const clean = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    extracted = JSON.parse(clean);
                } catch(e) { console.error(e); }
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Analisar Automaticamente';
            } else {
                // Simple keyword matching fallback
                if(text.toLowerCase().includes('gestante')) { extracted.priority = 'Urgente'; extracted.tags.push('Saúde'); }
                if(text.toLowerCase().includes('venezuela')) extracted.origin = 'Venezuela';
            }

            // Fill Form
            const form = document.getElementById('form-triagem');
            form.elements['name'].value = extracted.name;
            form.elements['origin'].value = extracted.origin;
            form.elements['priority'].value = extracted.priority;
            
            // Check tags
            const checkboxes = form.querySelectorAll('input[name="tags"]');
            checkboxes.forEach(cb => cb.checked = false);
            if(extracted.tags) {
                extracted.tags.forEach(t => {
                    const cb = Array.from(checkboxes).find(c => t.includes(c.value));
                    if(cb) cb.checked = true;
                });
            }
            
            Toastify({ text: "Formulário preenchido pela IA", style: { background: "#6366f1" } }).showToast();
        }

        function saveCase(e) {
            e.preventDefault();
            const f = e.target;
            const newCase = {
                id: Date.now(),
                protocol: `GO-2025-${Math.floor(Math.random()*1000)}`,
                name: f.elements['name'].value,
                origin: f.elements['origin'].value,
                phone: f.elements['phone'].value,
                priority: f.elements['priority'].value,
                status: f.elements['priority'].value === 'Urgente' ? 'urgente' : 'andamento',
                narrative: document.getElementById('narrative-input').value,
                steps: [{ entity: 'Triagem', desc: 'Abertura de protocolo.', date: new Date().toLocaleDateString(), status: 'done' }],
                files: []
            };
            db.cases.unshift(newCase);
            Toastify({ text: "Protocolo gerado com sucesso!", style: { background: "#10B981" } }).showToast();
            f.reset();
            nav('dashboard');
        }

        // --- Cases List View ---
        function renderCasesList(filter = '') {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = db.cases
                .filter(c => c.name.toLowerCase().includes(filter.toLowerCase()) || c.protocol.toLowerCase().includes(filter.toLowerCase()))
                .map(c => `
                <div onclick="openCase(${c.id})" class="bg-white border border-gray-200 p-5 rounded-xl hover:shadow-md cursor-pointer transition group">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded group-hover:bg-blue-50 group-hover:text-blue-600 transition">${c.protocol}</span>
                        <span class="text-[10px] uppercase font-bold ${getStatusColor(c.priority)} px-2 py-1 rounded-full">${c.priority}</span>
                    </div>
                    <h4 class="font-bold text-gray-800 text-lg mb-1">${c.name}</h4>
                    <p class="text-sm text-gray-500 mb-4">${c.origin}</p>
                    <div class="flex items-center justify-between text-xs text-gray-400 border-t pt-3">
                        <span><i class="fa-solid fa-calendar mr-1"></i> ${c.steps[0].date}</span>
                        <i class="fa-solid fa-arrow-right text-gray-300 group-hover:text-blue-500 transition"></i>
                    </div>
                </div>
            `).join('');
        }

        // --- WhatsApp Notification ---
        async function notifyWhatsapp() {
            const c = db.cases.find(x => x.id === activeCaseId);
            let msg = `Olá ${c.name}. Atualização do seu protocolo ${c.protocol}: Status atual é ${c.status}.`;
            
            if(apiKey) {
                try {
                    const prompt = `Escreva uma mensagem curta e acolhedora de WhatsApp para ${c.name} (${c.origin}) informando que o caso ${c.protocol} teve andamento na ${c.steps[c.steps.length-1].entity}. Em português.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    msg = data.candidates[0].content.parts[0].text;
                } catch(e) {}
            }
            
            window.open(`https://wa.me/${c.phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Init
        renderRecentTable();
        updateStats();
    </script>
</body>
</html>
